"use client";

import { useMemo, Suspense, useState, useEffect } from "react";
import { useSearchParams } from "next/navigation";
import { Search, Filter, PackageX, Map, Compass } from "lucide-react";
import Image from "next/image";
import Link from "next/link";
import { formatPrice } from "@/utils/formatPrice";

function PackagesContent() {
	const searchParams = useSearchParams();
	const [searchTerm, setSearchTerm] = useState(
		searchParams.get("destination") || ""
	);
	const [selectedType, setSelectedType] = useState(
		searchParams.get("type") || "ëª¨ë“  ì¢…ë¥˜"
	);
	const [packages, setPackages] = useState<any[]>([]);
	const [loading, setLoading] = useState(true);
	
	// ìƒíƒœ ë³€ê²½ì„ ê°ì§€í•˜ëŠ” useEffect ì¶”ê°€
	useEffect(() => {
		console.log('ğŸ“¦ packages ìƒíƒœ ë³€ê²½ë¨:', packages.length);
	}, [packages]);
	
	useEffect(() => {
		console.log('â³ loading ìƒíƒœ ë³€ê²½ë¨:', loading);
	}, [loading]);

	// APIì—ì„œ íŒ¨í‚¤ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
	useEffect(() => {
		const fetchPackages = async () => {
			try {
				setLoading(true);
				console.log('ğŸ”„ íŒ¨í‚¤ì§€ ë°ì´í„° ìš”ì²­ ì‹œì‘...');
				
				const response = await fetch('/api/packages', {
					method: 'GET',
					cache: 'no-store'
				});
				
				console.log('ğŸ“¡ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
				
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				
				const data = await response.json();
				console.log('ğŸ“¥ API ì‘ë‹µ ë°ì´í„°:', { 
					type: typeof data, 
					isArray: Array.isArray(data), 
					length: Array.isArray(data) ? data.length : Object.keys(data).length,
					sample: Array.isArray(data) ? data[0] : data 
				});
				
				const packagesArray = Array.isArray(data) ? data : (data.packages || []);
				console.log('ğŸ“¦ íŒ¨í‚¤ì§€ ë°°ì—´ í¬ê¸°:', packagesArray.length);
				
				if (packagesArray.length === 0) {
					console.warn('âš ï¸ íŒ¨í‚¤ì§€ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
					setPackages([]); // ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
					return;
				}
				
				// DB ë°ì´í„°ë¥¼ packagesData í˜•ì‹ìœ¼ë¡œ ë³€í™˜
				const formattedPackages = packagesArray.map((pkg: any) => ({
					id: pkg._id || pkg.id, // MongoDBì˜ _id í•„ë“œ ìš°ì„  ì‚¬ìš©
					destination: pkg.destination || pkg.title, // destination í•„ë“œê°€ ì—†ìœ¼ë©´ title ì‚¬ìš©
					type: pkg.category || "í•´ì™¸ì—¬í–‰", // categoryë¥¼ typeìœ¼ë¡œ ë§¤í•‘
					title: pkg.title,
					description: pkg.description,
					price: pkg.price,
					duration: `${pkg.duration || 7}ì¼`,
					image: pkg.image_url || "https://images.unsplash.com/photo-1566073771259-6a8506099945?q=80&w=1740",
					rating: 4.5, // ê¸°ë³¸ê°’
					reviews: 128, // ê¸°ë³¸ê°’
					name: pkg.title // ê¸°ì¡´ ì½”ë“œì™€ì˜ í˜¸í™˜ì„±ì„ ìœ„í•´ ì¶”ê°€
				}));
				
				console.log('âœ¨ ë³€í™˜ëœ íŒ¨í‚¤ì§€ ë°ì´í„°:', {
					count: formattedPackages.length,
					sample: formattedPackages[0]
				});
				
				console.log('ğŸ¯ setPackages í˜¸ì¶œ ì§ì „...');
				setPackages(formattedPackages);
				console.log('âœ… setPackages í˜¸ì¶œ ì™„ë£Œ!');
			} catch (error) {
				console.error('íŒ¨í‚¤ì§€ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
				setPackages([]); // ì—ëŸ¬ ì‹œ ë¹ˆ ë°°ì—´
			} finally {
				setLoading(false);
			}
		};

		fetchPackages();
	}, []);

	useEffect(() => {
		const destination = searchParams.get("destination") || "";
		const type = searchParams.get("type") || "ëª¨ë“  ì¢…ë¥˜";
		setSearchTerm(destination);
		setSelectedType(type);
	}, [searchParams]);

	const filteredAndSortedPackages = useMemo(() => {
		console.log('ğŸ” í•„í„°ë§ ì‹œì‘:', {
			totalPackages: packages.length,
			searchTerm,
			selectedType,
			samplePackage: packages[0]
		});
		
		const filtered = packages.filter((pkg) => {
			const matchesSearch = pkg.destination
				.toLowerCase()
				.includes(searchTerm.toLowerCase());
			const matchesType =
				selectedType === "ëª¨ë“  ì¢…ë¥˜" || pkg.type === selectedType;
			
			const passes = matchesSearch && matchesType;
			if (!passes && packages.length > 0) {
				console.log('ğŸš« í•„í„° ì‹¤íŒ¨:', {
					title: pkg.title,
					destination: pkg.destination,
					type: pkg.type,
					searchTerm,
					selectedType,
					matchesSearch,
					matchesType
				});
			}
			
			return passes;
		});
		
		console.log('âœ… í•„í„°ë§ ê²°ê³¼:', filtered.length);
		return filtered;
	}, [packages, searchTerm, selectedType]);

	return (
		<div>
			{/* Hero Section */}
			<div className="relative h-[300px] bg-gradient-to-r from-gray-800 to-gray-900">
				<div className="absolute inset-0 overflow-hidden">
					<Image 
						src="https://images.unsplash.com/photo-1475066392170-59d55d96fe51?q=80&w=2070&auto=format&fit=crop"
						alt="ì—¬í–‰ ë°°ê²½ ì´ë¯¸ì§€"
						fill
						className="object-cover opacity-50"
						priority
					/>
				</div>
				<div className="absolute inset-0 bg-gradient-to-t from-neutral-900/80 via-neutral-900/60 to-neutral-900/40"></div>
				<div className="container mx-auto px-4 h-full flex flex-col justify-center items-center relative z-10">
					<h1 className="text-4xl md:text-5xl font-extrabold mb-3 text-white text-center tracking-tight">
						ë‚˜ì—ê²Œ ë”± ë§ëŠ” ì—¬í–‰ ì°¾ê¸°
					</h1>
					<p className="text-lg text-white/90 max-w-2xl text-center">
						TripStoreê°€ ì—„ì„ í•œ ê³ í’ˆì§ˆ ì—¬í–‰ ìƒí’ˆìœ¼ë¡œ ìŠì§€ ëª»í•  ì—¬ì •ì„ ì‹œì‘í•˜ì„¸ìš”
					</p>
				</div>
			</div>

			<div className="container mx-auto px-4 -mt-6 relative z-20 mb-8">
				{/* ê²€ìƒ‰ ë°” */}
				<div className="bg-white rounded-xl shadow-md p-4 max-w-3xl mx-auto">
					<div className="flex items-center">
						<div className="relative flex-1">
							<Search className="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-black" />
							<input
								type="text"
								placeholder="ì–´ë””ë¡œ ë– ë‚˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?"
								className="w-full pl-10 p-2 border-0 focus:outline-none focus:ring-0 text-neutral-800 font-medium placeholder-neutral-500"
								value={searchTerm}
								onChange={(e) => setSearchTerm(e.target.value)}
							/>
						</div>
						<div className="border-l border-gray-200 mx-2 h-6"></div>
						<div className="relative flex items-center">
							<select
								className="appearance-none border-0 p-2 pr-8 focus:outline-none focus:ring-0 bg-transparent text-neutral-800 font-medium"
								value={selectedType}
								onChange={(e) => setSelectedType(e.target.value)}
							>
								<option>ëª¨ë“  ì¢…ë¥˜</option>
								<option>íœ´ì–‘</option>
								<option>ë¬¸í™”íƒë°©</option>
								<option>ì–´ë“œë²¤ì²˜</option>
								<option>ì»¤í”Œ</option>
							</select>
						</div>
					</div>
				</div>

				<div className="container mx-auto px-4 py-8">
					{/* í•„í„° ë° ì •ë ¬ ë²„íŠ¼ */}
					<div className="flex flex-wrap items-center justify-between mb-6">
						<div className="flex items-center mb-3 md:mb-0">
							<Filter className="w-5 h-5 mr-2 text-blue-500" />
							<h2 className="text-lg font-medium text-gray-700">ìƒì„¸ ê²€ìƒ‰</h2>
						</div>
						<div className="flex flex-wrap gap-2">
							{["ëª¨ë“  ì¢…ë¥˜", "íœ´ì–‘", "ë¬¸í™”íƒë°©", "ì–´ë“œë²¤ì²˜", "ì»¤í”Œ"].map((type) => (
								<button
									key={type}
									className={`px-3 py-1 text-sm border border-gray-200 rounded-md transition-colors ${
										selectedType === type
											? "bg-gray-800 text-white border-gray-800" 
											: "bg-white text-gray-700 hover:bg-gray-50"
									}`}
									onClick={() => setSelectedType(type)}
								>
									{type}
								</button>
							))}
						</div>
					</div>
					
					{/* ê²°ê³¼ ì¹´ìš´í„° */}
					<div className="mb-6">
						{loading ? (
							<div className="flex items-center space-x-2">
								<div className="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900"></div>
								<h2 className="text-xl font-bold text-gray-800">íŒ¨í‚¤ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h2>
							</div>
						) : (
							<h2 className="text-xl font-bold text-gray-800">
								{filteredAndSortedPackages.length > 0 ? (
									<>ë°œê²¬ëœ ì—¬í–‰ ìƒí’ˆ <span className="text-gray-500">{filteredAndSortedPackages.length}ê°œ</span></>
								) : 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ'}
							</h2>
						)}
					</div>
					
					{/* Packages Grid */}
					<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
						{loading ? (
							// ë¡œë”© ìƒíƒœì—ì„œ ìŠ¤ì¼ˆë ˆí†¤ UI í‘œì‹œ
							Array.from({ length: 6 }).map((_, index) => (
								<div key={index} className="bg-white border border-gray-100 rounded-lg shadow-sm overflow-hidden animate-pulse">
									<div className="h-48 bg-gray-200"></div>
									<div className="p-4">
										<div className="h-6 bg-gray-200 rounded mb-2"></div>
										<div className="h-4 bg-gray-200 rounded mb-3"></div>
										<div className="h-4 bg-gray-200 rounded w-2/3"></div>
									</div>
								</div>
							))
						) : filteredAndSortedPackages.length > 0 ? (
							filteredAndSortedPackages.map((pkg) => (
								<Link
									href={`/packages/${pkg.id}`}
									key={pkg.id}
									className="bg-white border border-gray-100 rounded-lg shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden group flex flex-col h-full"
								>
									<div className="relative h-48 w-full overflow-hidden">
										<Image
											src={pkg.image}
											alt={pkg.name}
											fill
											sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
											className="object-cover"
										/>
										<div className="absolute top-3 left-3">
											<span className="bg-white py-1 px-2 text-xs font-medium text-gray-800 rounded-sm">
												{pkg.type}
											</span>
										</div>
									</div>
									<div className="p-4 flex flex-col flex-grow">
										<h3 className="text-lg font-bold text-gray-800 mb-1">
											{pkg.name}
										</h3>
										<p className="text-gray-600 text-sm mb-3 line-clamp-2">
											{pkg.description}
										</p>
										<div className="flex items-center justify-between mt-auto">
											<span className="text-lg font-bold text-gray-900">
												{formatPrice(pkg.price)}
											</span>
										</div>
									</div>
								</Link>
							))
						) : (
							<div className="col-span-1 md:col-span-2 lg:col-span-3">
								<div className="flex flex-col items-center justify-center text-center py-16 px-6 bg-white border border-gray-100 rounded-lg">
									<PackageX className="w-16 h-16 text-gray-300 mb-6" />
									<h3 className="text-2xl font-bold text-gray-800 mb-2">
										ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤
									</h3>
									<p className="text-gray-500 max-w-md mb-6">
										ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„°ë¥¼ ì‚¬ìš©í•´ ë³´ì„¸ìš”. ë©‹ì§„ ì—¬í–‰ì´
										ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì„ ê±°ì˜ˆìš”!
									</p>
									<button 
										onClick={() => {
											setSearchTerm("");
											setSelectedType("ëª¨ë“  ì¢…ë¥˜");
										}}
										className="px-4 py-2 bg-gray-800 text-white rounded-md font-medium hover:bg-gray-700 transition-colors"
									>
										ëª¨ë“  ì—¬í–‰ ë³´ê¸°
									</button>
								</div>
							</div>
						)}
					</div>
					<div className="mt-10 text-center text-gray-500 text-sm">
						<p>ëª©ì ì§€ë¥¼ ì„ íƒí•˜ê³  ì™„ë²½í•œ ì—¬í–‰ì„ ê³„íší•´ë³´ì„¸ìš”</p>
						<p>ë” ë§ì€ ìƒí’ˆì´ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤</p>
					</div>
				</div>
			</div>
		</div>
	);
}

export default function PackagesPage() {
	return (
		<Suspense fallback={
			<div className="h-screen w-full flex items-center justify-center">
				<div className="animate-pulse flex flex-col items-center">
					<div className="w-8 h-8 border-4 border-gray-300 border-t-gray-800 rounded-full animate-spin mb-3"></div>
					<p className="text-sm text-gray-600">ë¡œë”© ì¤‘...</p>
				</div>
			</div>
		}>
			<PackagesContent />
		</Suspense>
	);
}
